<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy JS - Extreme Edition</title>
    <style>
        body, html {
            margin: 0; padding: 0; width: 100%; height: 100%;
            overflow: hidden; background: #111;
            display: flex; justify-content: center; align-items: center;
            font-family: 'Segoe UI', sans-serif;
        }
        canvas { display: block; background: #70c5ce; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center;
            pointer-events: none; z-index: 10;
        }
        .menu-box {
            background: rgba(0, 0, 0, 0.9); padding: 30px;
            border-radius: 30px; border: 4px solid #f8e71c;
            text-align: center; pointer-events: auto;
            box-shadow: 0 0 50px rgba(0,0,0,0.5); min-width: 360px;
        }
        .menu-title {
            font-size: 40px; margin: 0 0 15px 0; color: #f8e71c;
            text-shadow: 4px 4px 0 #e86101; text-transform: uppercase;
        }
        .coins-display {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0,0,0,0.6); color: #f8e71c;
            padding: 10px 25px; border-radius: 30px;
            font-size: 24px; font-weight: bold; border: 2px solid #f8e71c;
            z-index: 20;
        }
        /* –°–µ—Ç–∫–∞ –∫–Ω–æ–ø–æ–∫ –¥–ª—è —Ä–µ–∂–∏–º–æ–≤ */
        .btn-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            margin-bottom: 12px;
        }
        button {
            width: 100%; padding: 12px; font-size: 16px; font-weight: bold;
            cursor: pointer; background: #e86101; color: white;
            border: none; border-radius: 50px; transition: 0.2s;
            box-shadow: 0 4px 0 #a04300; text-transform: uppercase;
        }
        button.medium-btn { background: #27ae60; box-shadow: 0 4px 0 #1e8449; }
        button.hardcore-btn { background: #c0392b; box-shadow: 0 4px 0 #7b241c; }
        button.insane-btn { background: #2980b9; box-shadow: 0 4px 0 #1c5982; }
        button.extreme-btn { background: #8e44ad; box-shadow: 0 4px 0 #5b2c6f; }
        button.apocalypse-btn { background: #000; color: #ff0000; border: 1px solid #ff0000; box-shadow: 0 4px 0 #500; }
        
        button:hover { filter: brightness(1.2); transform: translateY(-2px); }
        button:active { transform: translateY(2px); box-shadow: 0 1px 0 #a04300; }
        
        .full-width { grid-column: span 2; }
        
        .audio-control {
            margin-top: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;
            color: white; font-weight: bold; font-size: 16px;
        }
        .switch {
            position: relative; display: inline-block; width: 50px; height: 26px;
        }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #555; transition: .4s; border-radius: 34px;
        }
        .slider:before {
            position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px;
            background-color: white; transition: .4s; border-radius: 50%;
        }
        input:checked + .slider { background-color: #e86101; }
        input:checked + .slider:before { transform: translateX(24px); }

        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px; }
        .skin-item { background: #333; padding: 10px; border-radius: 15px; border: 2px solid transparent; cursor: pointer; font-size: 12px; color: white; }
        .skin-item.active { border-color: #f8e71c; background: #444; }
        .skin-preview { width: 30px; height: 30px; border-radius: 50%; margin: 0 auto 5px; border: 1px solid #000; }
        
        .hidden { display: none !important; }
        #exit-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; display: none; z-index: 100; }
        
        #win-screen { color: #f8e71c; text-shadow: 3px 3px 0 #000; }
    </style>
</head>
<body>

    <div id="exit-screen"></div>
    <div class="coins-display">üí∞ <span id="total-coins">0</span></div>

    <div id="ui-layer">
        <!-- Main Menu -->
        <div id="main-menu" class="menu-box">
            <h1 class="menu-title">FLAPPY JS</h1>
            <div class="btn-grid">
                <button onclick="startGame('easy')">–õ–µ–≥–∫–∏–π</button>
                <button onclick="startGame('medium')" class="medium-btn">–°—Ä–µ–¥–Ω–∏–π</button>
                <button onclick="startGame('hardcore')" class="hardcore-btn">–•–∞—Ä–¥–∫–æ—Ä</button>
                <button onclick="startGame('insane')" class="insane-btn">–ë–µ–∑—É–º–∏–µ</button>
                <button onclick="startGame('extreme')" class="extreme-btn">–≠–∫—Å—Ç—Ä–∏–º</button>
                <button onclick="startGame('apocalypse')" class="apocalypse-btn">–ê–ø–æ–∫–∞–ª–∏–ø—Å–∏—Å</button>
                
                <button onclick="openShop()" class="full-width" style="background: #555; box-shadow: 0 4px 0 #222;">–ú–∞–≥–∞–∑–∏–Ω</button>
                <button onclick="exitGame()" class="full-width" style="background: #222; box-shadow: 0 4px 0 #000;">–í—ã–π—Ç–∏</button>
            </div>
            <div class="audio-control">
                <span>–ú–£–ó–´–ö–ê</span>
                <label class="switch">
                    <input type="checkbox" id="music-toggle" checked>
                    <span class="slider"></span>
                </label>
            </div>
        </div>

        <!-- Win Screen -->
        <div id="win-screen" class="menu-box hidden">
            <h1 class="menu-title">–ü–û–ë–ï–î–ê!</h1>
            <p id="win-reward-text" style="font-size: 20px; margin-bottom: 20px;">–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ 500 –æ—á–∫–æ–≤!</p>
            <button onclick="closeWinScreen()">–í –º–µ–Ω—é</button>
        </div>

        <!-- Shop Menu -->
        <div id="shop-menu" class="menu-box hidden">
            <h1 class="menu-title" style="font-size: 30px;">–ú–ê–ì–ê–ó–ò–ù</h1>
            <div class="shop-grid" id="shop-items"></div>
            <button onclick="closeShop()" style="margin-top: 15px; background: #555; box-shadow: 0 6px 0 #222; width: 100%;">–ù–∞–∑–∞–¥</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const totalCoinsEl = document.getElementById('total-coins');
        const shopMenu = document.getElementById('shop-menu');
        const mainMenu = document.getElementById('main-menu');
        const winScreen = document.getElementById('win-screen');
        const exitScreen = document.getElementById('exit-screen');
        const musicToggle = document.getElementById('music-toggle');

        let width, height;
        let bird, pipes, score, gameActive, frame;
        let spawnCounter = 0;
        let currentPipeSpeed = 4;
        let currentSpawnRate = 110;
        let gameMode = 'easy'; 
        let lastPipeHeight = null;
        const WIN_SCORE = 500;

        let playerData = {
            totalCoins: 0,
            currentSkin: '#f8e71c',
            ownedSkins: ['#f8e71c']
        };

        const skins = [
            { color: '#f8e71c', name: '–ñ–µ–ª—Ç—ã–π', price: 0 },
            { color: '#ff4757', name: '–ö—Ä–∞—Å–Ω—ã–π', price: 20 },
            { color: '#2ed573', name: '–ó–µ–ª–µ–Ω—ã–π', price: 50 },
            { color: '#1e90ff', name: '–°–∏–Ω–∏–π', price: 100 },
            { color: '#a29bfe', name: '–§–∏–æ–ª–µ—Ç', price: 200 },
            { color: '#ffffff', name: '–ë–µ–ª—ã–π', price: 500 }
        ];

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let bgMusicNode = null;

        function playSound(freq, type, duration, volume = 0.1) {
            if (!musicToggle.checked) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            gain.gain.setValueAtTime(volume, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        function startMusic() {
            if (!musicToggle.checked) return;
            if (bgMusicNode) bgMusicNode.stop();
            
            const bufferSize = 2 * audioCtx.sampleRate;
            const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            
            let baseFreq = 60;
            if (gameMode === 'extreme' || gameMode === 'apocalypse') baseFreq = 110;
            else if (gameMode === 'hardcore' || gameMode === 'insane') baseFreq = 85;

            let tempo = 0.25;
            if (gameMode === 'apocalypse') tempo = 0.08;
            else if (gameMode === 'extreme') tempo = 0.1;

            for (let i = 0; i < bufferSize; i++) {
                const t = i / audioCtx.sampleRate;
                data[i] = Math.sin(2 * Math.PI * baseFreq * t) * (1 - (t % 0.5) / 0.5) * 0.2;
                if (t % tempo < 0.01) data[i] += Math.random() * 0.1;
            }

            bgMusicNode = audioCtx.createBufferSource();
            bgMusicNode.buffer = buffer;
            bgMusicNode.loop = true;
            const gain = audioCtx.createGain();
            gain.gain.value = 0.15;
            bgMusicNode.connect(gain);
            gain.connect(audioCtx.destination);
            bgMusicNode.start();
        }

        function stopMusic() {
            if (bgMusicNode) {
                try { bgMusicNode.stop(); } catch(e) {}
                bgMusicNode = null;
            }
        }

        const sounds = {
            jump: () => playSound(350, 'sine', 0.15),
            score: () => playSound(700, 'triangle', 0.2),
            hit: () => playSound(100, 'sawtooth', 0.4, 0.2),
            win: () => {
                playSound(523.25, 'sine', 0.3);
                setTimeout(() => playSound(659.25, 'sine', 0.3), 150);
                setTimeout(() => playSound(783.99, 'sine', 0.5), 300);
            }
        };

        function resize() {
            width = window.innerWidth;
            height = window.innerHeight;
            canvas.width = width;
            canvas.height = height;
        }
        window.addEventListener('resize', resize);
        resize();

        const GRAVITY = 0.26;
        const JUMP_FORCE = -7.2;
        const PIPE_WIDTH = 80;
        const PIPE_GAP = 210;

        class Bird {
            constructor() {
                this.x = width / 4;
                this.y = height / 2;
                this.velocity = 0;
                this.radius = 24;
            }
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(Math.min(Math.PI/4, Math.max(-Math.PI/4, this.velocity * 0.05)));
                ctx.fillStyle = playerData.currentSkin;
                ctx.strokeStyle = "#000";
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fill(); ctx.stroke();
                ctx.fillStyle = "white"; ctx.beginPath(); ctx.arc(10, -8, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(13, -8, 3, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#e86101"; ctx.beginPath(); ctx.moveTo(18, 0); ctx.lineTo(35, 5); ctx.lineTo(18, 10); ctx.fill(); ctx.stroke();
                ctx.restore();
            }
            update() {
                this.velocity += GRAVITY;
                this.y += this.velocity;
                if (this.y + this.radius > height || this.y - this.radius < 0) gameOver();
            }
            jump() {
                this.velocity = JUMP_FORCE;
                sounds.jump();
            }
        }

        function getPipeColor() {
            switch(gameMode) {
                case 'apocalypse': return { main: "#ff0000", border: "#000000" };
                case 'extreme': return { main: "#8e44ad", border: "#5b2c6f" };
                case 'insane': return { main: "#2980b9", border: "#1c3d5a" };
                case 'hardcore': return { main: "#e74c3c", border: "#c0392b" };
                case 'medium': return { main: "#27ae60", border: "#1e8449" };
                default: return { main: "#2ecc71", border: "#1e8449" };
            }
        }

        function startGame(mode) {
            if (audioCtx.state === 'suspended') audioCtx.resume();
            gameMode = mode;
            bird = new Bird();
            pipes = [];
            score = 0;
            frame = 0;
            spawnCounter = 0;
            lastPipeHeight = height / 2 - PIPE_GAP / 2;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Ä–µ–∂–∏–º–∞
            if (mode === 'apocalypse') {
                currentPipeSpeed = 9.0;
                currentSpawnRate = 60;
            } else if (mode === 'extreme') {
                currentPipeSpeed = 7.5;
                currentSpawnRate = 70;
            } else if (mode === 'insane') {
                currentPipeSpeed = 6.8;
                currentSpawnRate = 80;
            } else if (mode === 'hardcore') {
                currentPipeSpeed = 6;
                currentSpawnRate = 85;
            } else if (mode === 'medium') {
                currentPipeSpeed = 5;
                currentSpawnRate = 95;
            } else { // easy
                currentPipeSpeed = 4;
                currentSpawnRate = 110;
            }
            
            gameActive = true;
            mainMenu.classList.add('hidden');
            shopMenu.classList.add('hidden');
            winScreen.classList.add('hidden');
            startMusic();
            animate();
        }

        function gameOver() {
            if (!gameActive) return;
            gameActive = false;
            sounds.hit();
            stopMusic();
            playerData.totalCoins += score;
            updateUI();
            mainMenu.classList.remove('hidden');
        }

        function winGame() {
            gameActive = false;
            stopMusic();
            sounds.win();
            
            let bonus = 100;
            if (gameMode === 'medium') bonus = 150;
            if (gameMode === 'hardcore') bonus = 200;
            if (gameMode === 'insane') bonus = 300;
            if (gameMode === 'extreme') bonus = 500;
            if (gameMode === 'apocalypse') bonus = 1000;
            
            playerData.totalCoins += score + bonus;
            document.getElementById('win-reward-text').innerText = `–í—ã –¥–æ—Å—Ç–∏–≥–ª–∏ ${WIN_SCORE} –æ—á–∫–æ–≤! –ù–∞–≥—Ä–∞–¥–∞: +${bonus} –º–æ–Ω–µ—Ç!`;
            
            updateUI();
            winScreen.classList.remove('hidden');
        }

        function closeWinScreen() {
            winScreen.classList.add('hidden');
            mainMenu.classList.remove('hidden');
        }

        function openShop() {
            mainMenu.classList.add('hidden');
            shopMenu.classList.remove('hidden');
            renderShop();
        }

        function closeShop() {
            shopMenu.classList.add('hidden');
            mainMenu.classList.remove('hidden');
        }

        function renderShop() {
            const container = document.getElementById('shop-items');
            container.innerHTML = '';
            skins.forEach(skin => {
                const isOwned = playerData.ownedSkins.includes(skin.color);
                const isActive = playerData.currentSkin === skin.color;
                const div = document.createElement('div');
                div.className = `skin-item ${isActive ? 'active' : ''}`;
                div.innerHTML = `
                    <div class="skin-preview" style="background: ${skin.color}"></div>
                    <div style="margin-bottom: 2px;">${skin.name}</div>
                    <div style="font-weight: bold; color: ${isOwned ? '#2ed573' : '#f8e71c'}">
                        ${isActive ? '–í–´–ë–†–ê–ù' : (isOwned ? '–û–î–ï–¢–¨' : skin.price + 'üí∞')}
                    </div>
                `;
                div.onclick = () => {
                    if (isOwned) {
                        playerData.currentSkin = skin.color;
                    } else if (playerData.totalCoins >= skin.price) {
                        playerData.totalCoins -= skin.price;
                        playerData.ownedSkins.push(skin.color);
                        playerData.currentSkin = skin.color;
                    }
                    updateUI();
                    renderShop();
                };
                container.appendChild(div);
            });
        }

        function updateUI() {
            totalCoinsEl.innerText = playerData.totalCoins;
        }

        function exitGame() {
            exitScreen.style.display = 'block';
            stopMusic();
        }

        window.addEventListener('keydown', (e) => { if (e.code === 'Space' && gameActive) bird.jump(); });
        canvas.addEventListener('mousedown', () => { if (gameActive) bird.jump(); });

        function animate() {
            if (!gameActive) return;
            
            let bgColor = "#70c5ce";
            if (gameMode === 'medium') bgColor = "#34495e";
            if (gameMode === 'hardcore') bgColor = "#4a1919";
            if (gameMode === 'insane') bgColor = "#1c1c1c";
            if (gameMode === 'extreme') bgColor = "#2c1b3d";
            if (gameMode === 'apocalypse') bgColor = "#1a0000";
            
            ctx.fillStyle = bgColor; ctx.fillRect(0, 0, width, height);

            spawnCounter += 1;
            if (spawnCounter >= currentSpawnRate) {
                const minH = 120;
                const maxH = height - PIPE_GAP - minH;
                const maxDiff = 180;
                
                let topH = lastPipeHeight + (Math.random() * maxDiff * 2 - maxDiff);
                topH = Math.max(minH, Math.min(topH, maxH));
                
                lastPipeHeight = topH;
                pipes.push({ x: width, top: topH, passed: false });
                spawnCounter = 0;
            }

            const colors = getPipeColor();

            for (let i = pipes.length - 1; i >= 0; i--) {
                let p = pipes[i];
                p.x -= currentPipeSpeed;
                
                ctx.fillStyle = colors.main; ctx.strokeStyle = colors.border; ctx.lineWidth = 4;
                ctx.fillRect(p.x, 0, PIPE_WIDTH, p.top);
                ctx.strokeRect(p.x, -5, PIPE_WIDTH, p.top + 5);
                ctx.fillRect(p.x, p.top + PIPE_GAP, PIPE_WIDTH, height);
                ctx.strokeRect(p.x, p.top + PIPE_GAP, PIPE_WIDTH, height);

                if (bird.x + 18 > p.x && bird.x - 18 < p.x + PIPE_WIDTH) {
                    if (bird.y - 18 < p.top || bird.y + 18 > p.top + PIPE_GAP) gameOver();
                }
                
                if (!p.passed && p.x + PIPE_WIDTH < bird.x) {
                    let increment = 1;
                    if (gameMode === 'medium') increment = Math.random() < 0.5 ? 1 : 2;
                    else if (gameMode === 'hardcore') increment = 2;
                    else if (gameMode === 'insane') increment = 5; // –§–∏–∫—Å 5 –æ—á–∫–æ–≤
                    else if (gameMode === 'extreme') increment = 3;
                    else if (gameMode === 'apocalypse') increment = Math.floor(Math.random() * 6) + 5; // 5-10 –æ—á–∫–æ–≤
                    
                    score += increment; 
                    p.passed = true; 
                    sounds.score();
                    
                    // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É—Å–∫–æ—Ä–µ–Ω–∏–µ
                    currentPipeSpeed += (gameMode === 'apocalypse' ? 0.05 : 0.03);
                    currentSpawnRate = Math.max(45, currentSpawnRate - 0.2);

                    if (score >= WIN_SCORE) {
                        winGame();
                        return;
                    }
                }
                if (p.x + PIPE_WIDTH < -100) pipes.splice(i, 1);
            }

            bird.update(); bird.draw();
            
            ctx.fillStyle = "white"; ctx.font = "bold 70px Arial"; ctx.textAlign = "center";
            ctx.strokeStyle = "black"; ctx.lineWidth = 6;
            ctx.strokeText(score, width / 2, 80);
            ctx.fillText(score, width / 2, 80);
            
            let label = "";
            let labelColor = "white";
            switch(gameMode) {
                case 'easy': label = "–†–ï–ñ–ò–ú: –õ–ï–ì–ö–ò–ô"; break;
                case 'medium': label = "–†–ï–ñ–ò–ú: –°–†–ï–î–ù–ò–ô (1-2 –û–ß–ö–ê)"; labelColor = "#27ae60"; break;
                case 'hardcore': label = "–†–ï–ñ–ò–ú: –•–ê–†–î–ö–û–† (X2)"; labelColor = "#e74c3c"; break;
                case 'insane': label = "–†–ï–ñ–ò–ú: –ë–ï–ó–£–ú–ò–ï (X5)"; labelColor = "#3498db"; break;
                case 'extreme': label = "–†–ï–ñ–ò–ú: –≠–ö–°–¢–†–ò–ú (X3)"; labelColor = "#a569bd"; break;
                case 'apocalypse': label = "–†–ï–ñ–ò–ú: –ê–ü–û–ö–ê–õ–ò–ü–°–ò–° (5-10 –û–ß–ö–û–í)"; labelColor = "#ff0000"; break;
            }
            
            if (label) {
                ctx.fillStyle = labelColor;
                ctx.font = "bold 20px Arial";
                ctx.fillText(label, width / 2, 115);
            }
            
            frame++;
            requestAnimationFrame(animate);
        }

        updateUI();
    </script>
</body>
</html>